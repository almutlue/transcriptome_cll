---
title: "FeirreraGroups"
author: "Almut Luetge"
date: "August 21, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##21.08.2017
#Compare C1/C2 groups from Feirrera paper to our findings.
They seem to be inferred by the IGHV status (see paper fig 4). Test weather IGHv is a confounding factor for c1c2 cluster in our data as well?

Analysis:
define c1c2 cluster new, for IGHV M/U seperately. Do we still find the c1c2 cluster?  


```{r libraries}
library(tidyverse)
library(DESeq2)
library(VennDiagram)
library(dplyr)
library(magrittr)
library(gridExtra)
library(pheatmap)
library(matrixStats)
library(piano)
library(limma)
library(ggvis)
library(pheatmap)
library(RColorBrewer)
library(ggdendro)
library(corrplot)
library(polycor)
```

1. load data

```{r data }
#RNA dataset
load("/home/almut/Documents/CLL/data/2017-08-16_ddsrna_trimmed.RData")
#subset with CLL patients only
cll_vector <- c("CLL", "atyp CLL", "Atyp. CLL","CLL/ET")
dds <- dds[,colData(dds)$diag %in% cll_vector]


#Diff expressed gene list from Feirrera
fileName <- paste("/home/almut/Documents/CLL/data/FeirreraPaper/Supplemental_File2_diffExpGenesC1C2_FC2.csv")
c1c2_genes <- read.csv(fileName,sep = ",",row.names = 1,header = TRUE)

load("/home/almut/Documents/CLL/data/patmetaGroups_170324.RData") 

#annotate methylation cluster
methCluster <- patMeta[which(patMeta$Patient.ID %in% colData(dds)$PatID), c("Methylation_Cluster", "Patient.ID")]
rownames(methCluster) <- methCluster$Patient.ID
colData(dds)$methClust <- methCluster$Methylation_Cluster[match(colData(dds)$PatID,rownames(methCluster))] 


```

2. Hierachical clustering of dds dataset using the c1c2 genes 

```{r Preprocessing}
#subset with CLL patients only
ddsC1C2 <- dds[which(rownames(dds) %in% rownames(c1c2_genes)),]

#Use patients with IGHV status mutated only
ddsC1C2<-ddsC1C2[,which(colData(ddsC1C2)$IGVH %in% "U")]


#number genes and samples
dim(dds)
ngenes <-nrow(ddsC1C2)
nsamples <-ncol(ddsC1C2)

# Remove rows/genes with too few counts
keep <-apply(counts(ddsC1C2), 1, function(x) any(x >= 10))
ddsC1C2 <- ddsC1C2[keep,]
dim(ddsC1C2)


#Variance stabilization transformation of the raw data
ddsC1C2 <- estimateSizeFactors(ddsC1C2)
RNAnorm <- varianceStabilizingTransformation(ddsC1C2, blind=T)


```


```{r s-to-s-distances, fig.width=40, fig.height=40, cache=TRUE}
sampleDists <- dist(t(assay(RNAnorm)))
sampleDistMat <- as.matrix(sampleDists)
rownames(sampleDistMat) <- paste0(colData(RNAnorm)$PatID, "_", colData(RNAnorm)$IGVH, "_", colData(RNAnorm)$batch)

sampleDistDat <- t(assay(RNAnorm))
rownames(sampleDistDat) <- colData(RNAnorm)$PatID


colnames(sampleDistMat) <- NULL

#Plot haetmap
colors <- colorRampPalette( rev(brewer.pal(20,"RdBu")) )(255)
pheatmap(sampleDistMat, clustering_distance_rows = sampleDists, clustering_distance_cols = sampleDists, col = colors, clustering_method = "ward.D2", fontsize = 25)


```

```{r hclust, fig.width = 40, fig.heigth = 90}
#hclust object
c1c2_cluster <- hclust(dist(sampleDistDat), method = "ward.D2", members = NULL)

## S3 method for class 'hclust'
plot(c1c2_cluster, labels = rownames(sampleDistMat), hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = TRUE,
     main = "Cluster by groups from Feirrera et al.",
     sub = NULL, xlab = "CLL_patients", ylab = "Height")


dendr    <- dendro_data(c1c2_cluster, type="rectangle") # convert for ggplot
clust    <- cutree(c1c2_cluster,k=2)                    # find 2 clusters
clust.df <- data.frame(label=names(clust), cluster=factor(clust))

# dendr[["labels"]] has the labels, merge with clust.df based on label column
dendr[["labels"]] <- merge(dendr[["labels"]], clust.df, by="label")

# plot the dendrogram; note use of color=cluster in geom_text(...)
ggplot() + geom_segment(data=segment(dendr), aes(x=x, y=y, xend=xend, yend=yend)) + 
  geom_text(data=label(dendr), aes(x, y, label=label, hjust=0, color=cluster), 
           size=8) +
        coord_flip() + scale_y_reverse(expand=c(0.9, 0)) + 
        ggtitle("Clustering by c1c2-genes") +
        theme(axis.line.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_text(size = 20),
        axis.text.x=element_text(size = 20),
        axis.title = element_blank(),
        panel.background=element_rect(fill="white"),
        panel.grid=element_blank(),
        plot.title = element_text(size = 80)) 
        


## S3 method for class 'hclust'
plot(c1c2_cluster, labels = rownames(sampleDistMat), hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = TRUE,
     main = "Cluster by groups from Feirrera et al.",
     sub = NULL, xlab = "CLL_patients", ylab = "Height")


##Add group information to patients
colData(ddsC1C2)$c1c2 <- clust.df$cluster[match(colData(ddsC1C2)$PatID,rownames(clust.df))] 

#vector to compare clustering with all and IGH-M genes only
clusterAll <- as.data.frame(patMeta[which(patMeta$Patient.ID %in% rownames(clust.df)),])
rownames(clusterAll) <- clusterAll$Patient.ID
clustercomp <- cbind(clust.df, clusterAll[rownames(clust.df),"c1c2"])


#Add c1c2 cluster information to patmeta data --> only neccessary if changes occur -overwrites it
#patMeta$c1c2 <- clust.df$cluster[match(patMeta$Patient.ID, rownames(clust.df))]

#save(patMeta, file = "/home/almut/Documents/CLL/data/patmetaGroups_170324.RData")

```



##PCA c1c2 genes only
```{r pca , fig.height=22, fig.width=16}
#Plot PCA based on c1c2genes only
exprMat <- assay(RNAnorm)

#top 5000 most variant genes
#sds <- rowSds(exprMat)
#exprMat <- exprMat[order(sds, decreasing = T)[1:5000],]


#Calculate PCA
pcaRes <- prcomp(t(exprMat), scale =T)
varExp <- (pcaRes$sdev^2 / sum(pcaRes$sdev^2)) * 100
pcaTab <- data.frame(pcaRes$x[,c(1:10)])
names(varExp) <- colnames(pcaRes$x)

#add background information
pcaTab <- cbind(pcaTab, data.frame(colData(RNAnorm)))
pcaTab$batch <- as.factor(pcaTab$batch)

#plot PCA and color samples based on annotations
featureList <- c("batch","IGVH","trisomy12","methClust","RNAprep", "del13q14")

pList <- lapply(featureList, function(feature) {
  ggplot(pcaTab, aes_string(x="PC1",y="PC2", color = feature)) + geom_point(size = 3) + theme_bw() + 
    xlab(sprintf("PC1 (%2.1f%%)",varExp[1])) + ylab(sprintf("PC2 (%2.1f%%)",varExp[2])) + 
    ggtitle(feature) + theme(plot.title = element_text(hjust = 0.5, color="red", size = 20)) +
    theme(axis.title.x = element_text(face="bold", size=20), axis.text.x=element_text(size=16)) + theme(axis.title.y = element_text(face="bold", size=20), axis.text.y= element_text(size=16)) #+
    #theme(legend.box.margin = margin(6, 6, 6, 6), legend.text = element_text(size = 15), legend.title = element_text(face = "bold", size = 10)) 
 })

grid.arrange(grobs = pList, ncol =2)

```


##Gene expression of c1c2 genes
```{r, hierachical clustering, fig.width=18, fig.height=70}
colAnno <- pcaTab[,c("batch","IGVH","trisomy12","Gender","RNAprep", "del13q14")]

#scale and censor
exprMat.new <- log2(exprMat)
exprMat.new <- t(scale(t(exprMat.new)))
exprMat.new[exprMat.new > 4] <- 4
exprMat.new[exprMat.new < -4] <- -4

pheatmap(exprMat.new, treeheight_row = 0, scale = "row", annotation_col = colAnno, 
         labels_row = paste0(rowData(RNAnorm[rownames(exprMat.new),])$symbol),
         clustering_method = "ward.D2", fontsize = 20, fontsize_row = 15)
```


#Can you find c1c2 cluster in dds with all genes
```{r hierachical clustering}
#subset with CLL patients only
cll_vector <- c("CLL", "atyp CLL", "Atyp. CLL","CLL/ET")
ddsCLL <- dds[,colData(dds)$diag %in% cll_vector]


#number genes and samples
dim(dds)
dim(ddsCLL)
ngenes <-nrow(ddsCLL)
nsamples <-ncol(ddsCLL)

# Remove rows/genes with too few counts
keep <-apply(counts(ddsCLL), 1, function(x) any(x >= 10))
ddsCLL <- ddsCLL[keep,]

#Variance stabilization transformation of the raw data
ddsCLL <- estimateSizeFactors(ddsCLL)
RNAnorm <- varianceStabilizingTransformation(ddsCLL, blind=T)
```


```{r s-to-s-distances, fig.width=20, fig.height=20, cache=TRUE}
sampleDists <- dist(t(assay(RNAnorm)))
sampleDistMat <- as.matrix(sampleDists)
rownames(sampleDistMat) <- paste0(colData(RNAnorm)$PatID, "_", colData(RNAnorm)$IGVH, "_", colData(RNAnorm)$c1c3)

sampleDistDat <- t(assay(RNAnorm))
rownames(sampleDistDat) <- paste0(colData(RNAnorm)$PatID, "_", colData(RNAnorm)$c1c2)


colnames(sampleDistMat) <- NULL

#Plot haetmap
colors <- colorRampPalette( rev(brewer.pal(9,"RdBu")) )(255)
pheatmap(sampleDistMat, clustering_distance_rows = sampleDists, clustering_distance_cols = sampleDists, col = colors, clustering_method = "ward.D2")


```

```{r clustering all genes, fig.width=30, fig.height= 20}
#hclust object
c1c2_cluster <- hclust(dist(sampleDistDat), method = "ward.D2", members = NULL)

## S3 method for class 'hclust'
plot(c1c2_cluster, labels = rownames(sampleDistMat), hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = TRUE,
     main = "Cluster by groups from Feirrera et al.",
     sub = NULL, xlab = "CLL_patients", ylab = "Height")


dendr    <- dendro_data(c1c2_cluster, type="rectangle") # convert for ggplot
clust    <- cutree(c1c2_cluster,k=2)                    # find 2 clusters
clust.df <- data.frame(label=names(clust), cluster=factor(clust))

# dendr[["labels"]] has the labels, merge with clust.df based on label column
dendr[["labels"]] <- merge(dendr[["labels"]], clust.df, by="label")

# plot the dendrogram; note use of color=cluster in geom_text(...)
ggplot() + geom_segment(data=segment(dendr), aes(x=x, y=y, xend=xend, yend=yend)) + 
  geom_text(data=label(dendr), aes(x, y, label=label, hjust=0, color=cluster), 
           size=10) +
        coord_flip() + scale_y_reverse(expand=c(0.2, 0)) + 
        theme(axis.line.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_rect(fill="white"),
        panel.grid=element_blank())


## S3 method for class 'hclust'
plot(c1c2_cluster, labels = rownames(sampleDistDat), hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = TRUE,
     main = "Cluster by groups from Feirrera et al.",
     sub = NULL, xlab = "CLL_patients", ylab = "Height")
```




##PCA with c1c2 cluster
```{r pca all genes, fig.height=22, fig.width=16}
#Plot PCA
exprMat <- assay(RNAnorm)

#top 5000 most variant genes
sds <- rowSds(exprMat)
exprMat <- exprMat[order(sds, decreasing = T)[1:5000],]


#Calculate PCA
pcaRes <- prcomp(t(exprMat), scale =T)
varExp <- (pcaRes$sdev^2 / sum(pcaRes$sdev^2)) * 100
pcaTab <- data.frame(pcaRes$x[,c(1:10)])
names(varExp) <- colnames(pcaRes$x)

#add background information
pcaTab <- cbind(pcaTab, data.frame(colData(RNAnorm)))
pcaTab$batch <- as.factor(pcaTab$batch)

#plot PCA and color samples based on annotations
featureList <- c("IGVH","trisomy12","RNAprep", "c1c2", "batch")

pList <- lapply(featureList, function(feature) {
  ggplot(pcaTab, aes_string(x="PC1",y="PC2", color = feature)) + geom_point(size = 3) + theme_bw() + 
    xlab(sprintf("PC1 (%2.1f%%)",varExp[1])) + ylab(sprintf("PC2 (%2.1f%%)",varExp[2])) + 
    ggtitle(feature) + theme(plot.title = element_text(hjust = 0.5, color="red", size = 20)) +
    theme(axis.title.x = element_text(face="bold", size=20), axis.text.x=element_text(size=16)) + theme(axis.title.y = element_text(face="bold", size=20), axis.text.y= element_text(size=16)) #+
    #theme(legend.box.margin = margin(6, 6, 6, 6), legend.text = element_text(size = 15), legend.title = element_text(face = "bold", size = 10)) 
 })

grid.arrange(grobs = pList, ncol =2)

```




##Correlation of c1c2 groups and genomic feature as found in patMeta 

```{r Corrplots, fig.width =15, fig.height = 15}
#generate Matrix with interesting features
patMat <- patMeta[which(patMeta$Patient.ID %in% colData(ddsCLL)$PatID),]
genomDat <- apply(patMat[,c(12:98)], 2, function(x) as.numeric(as.character(x)))
intGenom <- genomDat[, which(colSums(genomDat, na.rm=T) > 10)]

patMat <-patMat[, c("gender","diagnosis", "treatment", "IGHV.status","Methylation_Cluster", colnames(intGenom), "c1c2", "drugGroup")]
patMat <- lapply(patMat, function(x) as.factor(x))

patMat <- as.data.frame(patMat)

#Generate matrix with correlation coefficients
corMat <- hetcor(patMat, use = "pairwise.complete.obs")


corrplot.mixed(corMat$correlations, number.cex= 1.7, tl.cex=2, tl.pos = "lt", cl.cex=2, diag = "n")


```


```{r significant correlation, fig.height= 12, fig.width= 12}
cor.mtest <- function(mat, conf.level = 0.95){
  mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat <- lowCI.mat <- uppCI.mat <- matrix(NA, n, n)
    diag(p.mat) <- 0
    diag(lowCI.mat) <- diag(uppCI.mat) <- 1
    for(i in 1:(n-1)){
        for(j in (i+1):n){
            tmp <- cor.test(mat[,i], mat[,j], conf.level = conf.level)
            p.mat[i,j] <- p.mat[j,i] <- tmp$p.value
            lowCI.mat[i,j] <- lowCI.mat[j,i] <- tmp$conf.int[1]
            uppCI.mat[i,j] <- uppCI.mat[j,i] <- tmp$conf.int[2]
        }
    }
    return(list(p.mat, lowCI.mat, uppCI.mat))
}

res1 <- cor.mtest(corMat$correlations,0.95)
res2 <- cor.mtest(corMat$correlations,0.99)

corrplot.mixed(corMat$correlations, p.mat = res1[[1]], sig.level=0.1, insig = "blank", number.cex= 1.7, tl.cex=2, tl.pos = "lt", cl.cex=2, diag = "n")


```



